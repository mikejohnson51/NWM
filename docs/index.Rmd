---
title: National Water Model Access in R
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
---

```{r echo = FALSE, results='hide', warning= FALSE,message=FALSE}
devtools::load_all()
library(leaflet)
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
```


## What is the National Water Model?

In August 2016 the NOAA made the Nation

From NOAAs [webpage]("http://water.noaa.gov/about/nwm"):<br>

"The National Water Model (NWM) is a hydrologic model that simulates observed and forecast streamflow over the entire continental United States (CONUS). The NWM simulates the water cycle with mathematical representations of the different processes and how they fit together. This complex representation of physical processes such as snowmelt and infiltration and movement of water through the soil layers varies significantly with changing elevations, soils, vegetation types and a host of other variables. Additionally, extreme variability in precipitation over short distances and times can cause the response on rivers and streams to change very quickly. Overall, the process is so complex that to simulate it with a mathematical model means that it needs a very high powered computer or super computer in order to run in the time frame needed to support decision makers..."

## What are the challenges?

Each day the NWM outputs ~400 GB of data relating to streamflow, terrain and atmospheric processes for the CONUS. This data is stored for a 40 day rolling window on the HydroShare Thredds server. These outputs come from four unique model configurations that cycle on different intervals, using different forcing data, and generate different output. 

<strong>The first challenge this package hopes to address is how people come to understand and interact with the NWM output. </strong>

This first challenge is addressed with the `look` function

<strong>The second challenge is how to this data can be easily queried and subset to an Area of Interest. </strong>

The second challenge is addressed using the [`AOI` package](https://github.com/mikejohnson51/AOI) and the `getFilelist` and `downloadNWM` functions.

<strong>The third challenge is how to make these processes fast, effieicent, and usefull in the R environment. </strong>

This challenge is taken care of on the backend of the package making use of the parralization capabilites of `foreach` and `doParallel` [packages](https://cran.r-project.org/web/packages/doParallel/vignettes/gettingstartedParallel.pdf).

But first we need the package!

###Installation:

First things first, get up and running in R by downlaoding and installing the `NWM` package:

```{r, eval = F}
install.packages("devtools")
library(devtools)
install_github("mikejohnson51/NWM")
```

##Challenge #1: 
###Understanding the configurations, output types, data, units, and nomenclature.

The NWM runs on four unique configurations - each cycling on a different time intervals, producing forcasts out to different lengths, and including varying suites of parameters. 

```{r}
look("short_range")
```

At the most general level, each configuration generates three sets of outputs. `Channel` data are point values generated at the outlets of each of the 2.7 million NHDPusV2 reaches in the CONUS; `land` outputs are gridded data set to a 1 km grid; and forcing data are those parameters used to generate the `channel` and `land` forcasts 

```{r}
look("medium_range", 'channel')
```

Great so now using the `look` function you have the tools to check the parmaters, cycle time and forecast durations of any configuration, type combination! Now we can move one to actually getting that data!

##Challenge #2: 
###Querying data and subsetting to an AOI

Defining Area of Interests in the `nwm` package are based on the `AOI` package which was developed to help find, define, and refine AOI spatial objects. AOIs can be defined by a state, county or clip area. To learn more about this package please consult the package [documentation](https://mikejohnson51.github.io/AOI/).

Here is a basic example querying a 100 square mile AOI centered on 'Colorado Springs, Colorado'. The AOI `check()` function can be used to view its boundaries:

```{r, messages = FALSE}
getAOI(clip = list("Colorado Springs", 10, 10)) %>% check()
```

```{r}
AOI = getAOI(clip = list("Colorado Springs", 10, 10))

system.time({
  nhd <-getNHD(AOI)
})

head(nhd)

```

Here we see that we have 91 flowlines (so 91 points) where `channel` forecasts can be found from the NWM. To view these flowlines we can chain `leaflet::addPolylines()` to the `check(AOI)` call.

```{r}
library(leaflet)
check(AOI) %>% addPolylines(data = nhd)
```


```{r}
files = getFilelist(config = "medium_range", date = "20180712", type = "channel", t = c(0,6,12))

print(files)
```

```{r}
xx = system.time({
  flows <-downloadNWM(AOI, files, "streamflow")
})


```

`r xx[3]`

```{r}
head(flows, 8)
```

```{r}
max = flows[order(flows$cfs, decreasing = T),]
head(max)
```

```{r}
{par(mfrow = c(1,2))
vizFlows(AOI = AOI, data = flows, num = 10, max = TRUE)
vizFlows(AOI = AOI, nhd = nhd,  data = flows, num = 10, max = FALSE)}
```

```{r}
files = getFilelist(config = "medium_range", date = "20180711", type = "land", t = 6, f = seq(3,30,3))

nwm$medium_range$land$PARAM

system.time({
  et <-downloadNWM(AOI, files, "accet")
})

{par(mar = c(0.1, 0.1, 0.1, 0.1), mfrow = c(2,2))
raster::plot(et[[1:4]], nc = 2, nr = 2, axes=FALSE, box=FALSE,legend = TRUE, main = getGridTime(et[[1:4]]),
             legend.args=list(text= "ET (mm)", side=3, font=2, line=1, cex=0.5),
             legend.width=1, legend.shrink=0.75)}

check(AOI) %>% addRasterImage(x = et[[1]], opacity = .8)



```

```{r}
loc = "Garden of the Gods, Colorado Springs"

pt = getPoint(name = loc)

time = getGridTime(et)

et = raster::projectRaster(from = et, crs = aoiProj)

vals = raster::extract(et, y =  data.frame(pt$lon, pt$lat))

{plot(x = time, y = vals[1,], type = 'o', pch = 16, ylab = "ET", xlab = "Time (UTC)")
title(loc)}
```


